<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>账单记录</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#64748B',
            success: '#10B981',
            danger: '#EF4444',
            warning: '#F59E0B',
            info: '#06B6D4',
            light: '#F8FAFC',
            dark: '#1E293B',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/50 focus:border-primary;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-50 transition-all duration-300" id="header">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-money text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-dark">账单记录</h1>
      </div>
      <nav>
        <ul class="flex space-x-6">
          <li><button id="homeBtn" class="text-primary font-medium transition-colors duration-200 hover:text-primary/80">
            <i class="fa fa-home mr-1"></i> 首页
          </button></li>
          <li><button id="statsBtn" class="text-gray-600 font-medium transition-colors duration-200 hover:text-primary">
            <i class="fa fa-bar-chart mr-1"></i> 统计
          </button></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 pt-24 pb-20">
    <!-- 首页视图 -->
    <section id="homeView" class="block">
      <!-- 统计卡片 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-gray-600 font-medium">本月收入</h3>
            <i class="fa fa-arrow-up text-success text-xl"></i>
          </div>
          <p class="text-3xl font-bold text-dark" id="monthIncome">¥0.00</p>
        </div>
        
        <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-gray-600 font-medium">本月支出</h3>
            <i class="fa fa-arrow-down text-danger text-xl"></i>
          </div>
          <p class="text-3xl font-bold text-dark" id="monthExpense">¥0.00</p>
        </div>
        
        <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-gray-600 font-medium">本月结余</h3>
            <i class="fa fa-balance-scale text-primary text-xl"></i>
          </div>
          <p class="text-3xl font-bold text-dark" id="monthBalance">¥0.00</p>
        </div>
      </div>
      
      <!-- 操作按钮 -->
      <div class="flex justify-center mb-8">
        <button id="addIncomeBtn" class="bg-success hover:bg-success/90 text-white font-medium py-3 px-6 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 flex items-center mr-4">
          <i class="fa fa-plus-circle mr-2"></i> 记收入
        </button>
        <button id="addExpenseBtn" class="bg-danger hover:bg-danger/90 text-white font-medium py-3 px-6 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105 flex items-center">
          <i class="fa fa-minus-circle mr-2"></i> 记支出
        </button>
      </div>
      
      <!-- 交易记录列表 -->
      <div class="bg-white rounded-xl card-shadow p-4 md:p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-dark">最近交易</h2>
          <div class="flex space-x-2">
            <button class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded-full transition-colors duration-200">今天</button>
            <button class="text-sm bg-primary text-white py-1 px-3 rounded-full">本周</button>
            <button class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded-full transition-colors duration-200">本月</button>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
              </tr>
            </thead>
            <tbody id="transactionList">
              <!-- 交易记录将通过JavaScript动态添加 -->
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">2025-06-20</td>
                <td class="py-4 px-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">餐饮</span>
                </td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">午餐</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-right text-red-600">-¥35.00</td>
                <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
                  <button class="text-gray-500 hover:text-primary transition-colors duration-200 mr-3">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="text-gray-500 hover:text-danger transition-colors duration-200">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">2025-06-19</td>
                <td class="py-4 px-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">工资</span>
                </td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">5月工资</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-right text-green-600">+¥8500.00</td>
                <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
                  <button class="text-gray-500 hover:text-primary transition-colors duration-200 mr-3">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="text-gray-500 hover:text-danger transition-colors duration-200">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="mt-6 text-center">
          <button class="text-primary hover:text-primary/80 font-medium transition-colors duration-200">
            查看全部 <i class="fa fa-angle-right ml-1"></i>
          </button>
        </div>
      </div>
    </section>
    
    <!-- 统计视图 -->
    <section id="statsView" class="hidden">
      <div class="bg-white rounded-xl card-shadow p-6 mb-8">
        <h2 class="text-xl font-bold text-dark mb-6">支出分类统计</h2>
        <div class="h-80">
          <!-- 图表将通过JavaScript动态生成 -->
          <canvas id="expenseChart"></canvas>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl card-shadow p-6">
          <h2 class="text-xl font-bold text-dark mb-6">月度收支趋势</h2>
          <div class="h-64">
            <!-- 图表将通过JavaScript动态生成 -->
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>
        
        <div class="bg-white rounded-xl card-shadow p-6">
          <h2 class="text-xl font-bold text-dark mb-6">预算完成情况</h2>
          <div class="space-y-6">
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">餐饮</span>
                <span class="text-sm font-medium text-gray-700">¥1200 / ¥2000</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-red-500 h-2.5 rounded-full" style="width: 60%"></div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">交通</span>
                <span class="text-sm font-medium text-gray-700">¥500 / ¥800</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-500 h-2.5 rounded-full" style="width: 62.5%"></div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">购物</span>
                <span class="text-sm font-medium text-gray-700">¥1800 / ¥1500</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-purple-500 h-2.5 rounded-full" style="width: 120%"></div>
              </div>
            </div>
            
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">娱乐</span>
                <span class="text-sm font-medium text-gray-700">¥300 / ¥1000</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 30%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 添加交易模态框 -->
  <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-dark" id="modalTitle">添加收入</h3>
          <button id="closeModal" class="text-gray-400 hover:text-gray-500">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="transactionForm">
          <input type="hidden" id="transactionType" value="income">
          
          <div class="mb-4">
            <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">金额</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">¥</span>
              <input type="number" id="amount" name="amount" step="0.01" min="0" required
                class="pl-8 block w-full rounded-lg border border-gray-300 py-2.5 px-4 bg-white text-gray-700 shadow-sm focus:outline-none input-focus">
            </div>
          </div>
          
          <div class="mb-4">
            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
            <select id="category" name="category" required
              class="block w-full rounded-lg border border-gray-300 py-2.5 px-4 bg-white text-gray-700 shadow-sm focus:outline-none input-focus">
              <!-- 收入分类 -->
              <option value="salary">工资</option>
              <option value="bonus">奖金</option>
              <option value="investment">投资收益</option>
              <option value="other_income">其他收入</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label for="date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
            <input type="date" id="date" name="date" required
              class="block w-full rounded-lg border border-gray-300 py-2.5 px-4 bg-white text-gray-700 shadow-sm focus:outline-none input-focus">
          </div>
          
          <div class="mb-6">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
            <input type="text" id="description" name="description" placeholder="描述此笔交易..."
              class="block w-full rounded-lg border border-gray-300 py-2.5 px-4 bg-white text-gray-700 shadow-sm focus:outline-none input-focus">
          </div>
          
          <div class="flex space-x-3">
            <button type="button" id="cancelTransaction" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2.5 px-4 rounded-lg transition-colors duration-200">
              取消
            </button>
            <button type="submit" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2025 账单记录应用 | 为您的财务管理助力</p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script>
    // DOM元素
    const homeBtn = document.getElementById('homeBtn');
    const statsBtn = document.getElementById('statsBtn');
    const homeView = document.getElementById('homeView');
    const statsView = document.getElementById('statsView');
    const addIncomeBtn = document.getElementById('addIncomeBtn');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const transactionModal = document.getElementById('transactionModal');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');
    const cancelTransaction = document.getElementById('cancelTransaction');
    const transactionForm = document.getElementById('transactionForm');
    const transactionType = document.getElementById('transactionType');
    const modalTitle = document.getElementById('modalTitle');
    const categorySelect = document.getElementById('category');
    const header = document.getElementById('header');
    
    // 导航切换
    homeBtn.addEventListener('click', () => {
      homeView.classList.remove('hidden');
      statsView.classList.add('hidden');
      homeBtn.classList.add('text-primary');
      homeBtn.classList.remove('text-gray-600');
      statsBtn.classList.add('text-gray-600');
      statsBtn.classList.remove('text-primary');
    });
    
    statsBtn.addEventListener('click', () => {
      homeView.classList.add('hidden');
      statsView.classList.remove('hidden');
      homeBtn.classList.remove('text-primary');
      homeBtn.classList.add('text-gray-600');
      statsBtn.classList.remove('text-gray-600');
      statsBtn.classList.add('text-primary');
      
      // 初始化统计图表
      initCharts();
    });
    
    // 滚动效果
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) {
        header.classList.add('py-2');
        header.classList.remove('py-3');
        header.classList.add('shadow-lg');
      } else {
        header.classList.remove('py-2');
        header.classList.add('py-3');
        header.classList.remove('shadow-lg');
      }
    });
    
    // 打开模态框 - 收入
    addIncomeBtn.addEventListener('click', () => {
      transactionType.value = 'income';
      modalTitle.textContent = '添加收入';
      
      // 清空并设置收入分类选项
      categorySelect.innerHTML = '';
      const incomeCategories = ['工资', '奖金', '投资收益', '其他收入'];
      const incomeValues = ['salary', 'bonus', 'investment', 'other_income'];
      
      incomeCategories.forEach((cat, index) => {
        const option = document.createElement('option');
        option.value = incomeValues[index];
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      
      openModal();
    });
    
    // 打开模态框 - 支出
    addExpenseBtn.addEventListener('click', () => {
      transactionType.value = 'expense';
      modalTitle.textContent = '添加支出';
      
      // 清空并设置支出分类选项
      categorySelect.innerHTML = '';
      const expenseCategories = ['餐饮', '交通', '购物', '娱乐', '住房', '医疗', '其他支出'];
      const expenseValues = ['food', 'transport', 'shopping', 'entertainment', 'housing', 'medical', 'other_expense'];
      
      expenseCategories.forEach((cat, index) => {
        const option = document.createElement('option');
        option.value = expenseValues[index];
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      
      openModal();
    });
    
    // 关闭模态框
    closeModal.addEventListener('click', closeModalHandler);
    cancelTransaction.addEventListener('click', closeModalHandler);
    
    // 提交表单
    transactionForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const type = transactionType.value;
      const amount = parseFloat(document.getElementById('amount').value);
      const category = document.getElementById('category').value;
      const date = document.getElementById('date').value;
      const description = document.getElementById('description').value || '';
      
      // 准备数据
      const data = {
        type,
        amount,
        category,
        date,
        description
      };
      
      // 发送数据到后端
      fetch('/api/transactions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          // 成功提示
          alert('交易记录已保存！');
          closeModalHandler();
          // 刷新交易列表
          fetchTransactions();
          // 更新统计数据
          updateStatistics();
        } else {
          alert('保存失败: ' + result.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('发生错误，请稍后再试');
      });
    });
    
    // 辅助函数
    function openModal() {
      // 设置默认日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      
      // 显示模态框并添加动画
      transactionModal.classList.remove('hidden');
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    
    function closeModalHandler() {
      // 隐藏模态框并添加动画
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        transactionModal.classList.add('hidden');
        // 重置表单
        transactionForm.reset();
      }, 300);
    }
    
    // 初始化统计图表
    function initCharts() {
      // 获取支出分类数据
      fetch('/api/statistics/category-expenses')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.categories) {
            createExpenseChart(data.categories);
          }
        })
        .catch(error => {
          console.error('Error fetching category expenses:', error);
        });
      
      // 获取月度趋势数据
      fetch('/api/statistics/monthly-trends')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.trends) {
            createMonthlyChart(data.trends);
          }
        })
        .catch(error => {
          console.error('Error fetching monthly trends:', error);
        });
    }
    
    // 创建支出分类图表
    function createExpenseChart(categories) {
      const ctx = document.getElementById('expenseChart').getContext('2d');
      
      // 准备数据
      const labels = Object.keys(categories);
      const values = Object.values(categories);
      
      // 定义颜色
      const colors = [
        '#EF4444', '#F59E0B', '#10B981', '#3B82F6', 
        '#8B5CF6', '#EC4899', '#4F46E5', '#14B8A6'
      ];
      
      // 销毁现有图表（如果存在）
      if (window.expenseChart) {
        window.expenseChart.destroy();
      }
      
      // 创建图表
      window.expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 20,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ¥${value.toFixed(2)} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '65%'
        }
      });
    }
    
    // 创建月度趋势图表
    function createMonthlyChart(trends) {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      
      // 准备数据
      const months = trends.map(t => t.month);
      const incomes = trends.map(t => t.income);
      const expenses = trends.map(t => t.expense);
      const balances = trends.map(t => t.balance);
      
      // 销毁现有图表（如果存在）
      if (window.monthlyChart) {
        window.monthlyChart.destroy();
      }
      
      // 创建图表
      window.monthlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: '收入',
              data: incomes,
              backgroundColor: '#10B981',
              borderRadius: 4
            },
            {
              label: '支出',
              data: expenses,
              backgroundColor: '#EF4444',
              borderRadius: 4
            },
            {
              label: '结余',
              data: balances,
              backgroundColor: '#3B82F6',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += '¥' + context.parsed.y.toFixed(2);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                display: true,
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false
              }
            }
          }
        }
      });
    }
    
    // 获取交易记录
    function fetchTransactions() {
      fetch('/api/transactions')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.transactions) {
            renderTransactions(data.transactions);
          }
        })
        .catch(error => {
          console.error('Error fetching transactions:', error);
        });
    }
    
    // 渲染交易记录
    function renderTransactions(transactions) {
      const transactionList = document.getElementById('transactionList');
      transactionList.innerHTML = '';
      
      if (transactions.length === 0) {
        transactionList.innerHTML = `
          <tr>
            <td colspan="5" class="py-6 text-center text-gray-500">
              暂无交易记录
            </td>
          </tr>
        `;
        return;
      }
      
      transactions.forEach(transaction => {
        const isExpense = transaction.type === 'expense';
        const amountClass = isExpense ? 'text-red-600' : 'text-green-600';
        const amountSign = isExpense ? '-' : '+';
        const categoryColors = {
          // 收入分类颜色
          salary: 'bg-green-100 text-green-800',
          bonus: 'bg-green-100 text-green-800',
          investment: 'bg-green-100 text-green-800',
          other_income: 'bg-green-100 text-green-800',
          // 支出分类颜色
          food: 'bg-red-100 text-red-800',
          transport: 'bg-blue-100 text-blue-800',
          shopping: 'bg-purple-100 text-purple-800',
          entertainment: 'bg-yellow-100 text-yellow-800',
          housing: 'bg-indigo-100 text-indigo-800',
          medical: 'bg-pink-100 text-pink-800',
          other_expense: 'bg-gray-100 text-gray-800'
        };
        
        const categoryNames = {
          // 收入分类名称
          salary: '工资',
          bonus: '奖金',
          investment: '投资收益',
          other_income: '其他收入',
          // 支出分类名称
          food: '餐饮',
          transport: '交通',
          shopping: '购物',
          entertainment: '娱乐',
          housing: '住房',
          medical: '医疗',
          other_expense: '其他支出'
        };
        
        const categoryColor = categoryColors[transaction.category] || 'bg-gray-100 text-gray-800';
        const categoryName = categoryNames[transaction.category] || transaction.category;
        
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150';
        row.innerHTML = `
          <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${transaction.date}</td>
          <td class="py-4 px-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${categoryColor}">${categoryName}</span>
          </td>
          <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">${transaction.description}</td>
          <td class="py-4 px-4 whitespace-nowrap text-sm text-right ${amountClass}">${amountSign}¥${transaction.amount.toFixed(2)}</td>
          <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
            <button class="text-gray-500 hover:text-primary transition-colors duration-200 mr-3 edit-transaction" data-id="${transaction.id}">
              <i class="fa fa-pencil"></i>
            </button>
            <button class="text-gray-500 hover:text-danger transition-colors duration-200 delete-transaction" data-id="${transaction.id}">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        
        transactionList.appendChild(row);
      });
      
      // 添加编辑和删除事件监听
      document.querySelectorAll('.edit-transaction').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          // 实现编辑功能
          console.log('Edit transaction:', id);
        });
      });
      
      document.querySelectorAll('.delete-transaction').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (confirm('确定要删除这条交易记录吗？')) {
            fetch(`/api/transactions/${id}`, {
              method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
              if (result.success) {
                alert('交易记录已删除！');
                fetchTransactions();
                updateStatistics();
              } else {
                alert('删除失败: ' + result.message);
              }
            })
            .catch(error => {
              console.error('Error deleting transaction:', error);
              alert('发生错误，请稍后再试');
            });
          }
        });
      });
    }
    
    // 更新统计数据
    function updateStatistics() {
      fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('monthIncome').textContent = `¥${data.monthly_income.toFixed(2)}`;
            document.getElementById('monthExpense').textContent = `¥${data.monthly_expense.toFixed(2)}`;
            document.getElementById('monthBalance').textContent = `¥${data.monthly_balance.toFixed(2)}`;
          }
        })
        .catch(error => {
          console.error('Error fetching statistics:', error);
        });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 设置默认日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      
      // 加载交易记录
      fetchTransactions();
      
      // 更新统计数据
      updateStatistics();
    });
  </script>
</body>
</html>  